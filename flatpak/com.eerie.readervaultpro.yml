id: com.eerie.readervaultpro
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: "24.08"

sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22

command: reader-vault-pro
separate-locales: false

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --filesystem=xdg-documents
  - --filesystem=xdg-download

modules:
  # Build libvips into /app
  - libvips.json

  # Build app (sharp must compile against /app libvips)
  - name: reader-vault-pro
    buildsystem: simple

    build-options:
      append-path: /usr/lib/sdk/node22/bin
      env:
        XDG_CACHE_HOME: /run/build/reader-vault-pro/flatpak-node/cache
        npm_config_cache: /run/build/reader-vault-pro/flatpak-node/npm-cache

        # Make sure sharp can "see" libvips installed into /app
        PKG_CONFIG_PATH: /app/lib64/pkgconfig:/app/lib/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
        LD_LIBRARY_PATH: /app/lib64:/app/lib

        # Ensure vips tools are visible if anything probes them

        # node-gyp headers location
        npm_config_nodedir: /usr/lib/sdk/node22

        # Force building native addons from source
        npm_config_build_from_source: "true"

        # Reduce npm noise
        npm_config_loglevel: "warn"
        npm_config_progress: "false"
        npm_config_audit: "false"
        npm_config_fund: "false"
        npm_config_update_notifier: "false"

        # IMPORTANT:
        # Do NOT set SHARP_IGNORE_GLOBAL_LIBVIPS at all.
        # In sharp 0.32.x Boolean("0") is true, which *forces* download.

    build-commands:
      - mkdir -p /run/build/reader-vault-pro/flatpak-node/npm-cache

      # Sanity check: sharp uses pkg-config --modversion vips-cpp
      - pkg-config --modversion vips-cpp
      - pkg-config --cflags --libs vips-cpp

      # Install deps. If generated-sources.json is correct, this works offline.
      - |
        if [ -f package-lock.json ]; then
          npm ci --offline --foreground-scripts --loglevel=warn
        else
          npm install --offline --foreground-scripts --loglevel=warn
        fi

      - npm run build

      - install -d /app/main
      - cp -r dist /app/main/dist

      - if [ -d electron ]; then cp -r electron /app/main/electron; fi
      - if [ -d src ]; then cp -r src /app/main/src; fi
      - if [ -f main.js ]; then install -Dm644 main.js /app/main/main.js; fi

      - install -Dm644 package.json /app/main/package.json
      - if [ -f package-lock.json ]; then install -Dm644 package-lock.json /app/main/package-lock.json; fi

      - install -Dm755 flatpak/reader-vault-pro.sh /app/bin/reader-vault-pro
      - test -x /app/bin/reader-vault-pro
      - install -Dm644 assets/icon-512.png /app/share/icons/hicolor/512x512/apps/com.eerie.readervaultpro.png
      - install -Dm644 flatpak/com.eerie.readervaultpro.desktop /app/share/applications/com.eerie.readervaultpro.desktop
      - install -Dm644 flatpak/com.eerie.readervaultpro.metainfo.xml /app/share/metainfo/com.eerie.readervaultpro.metainfo.xml

    sources:
      - type: git
        url: https://github.com/EerieGoesD/game-guide-manager.git
        commit: 2c37ff4f718ba2a1ddbba31c340129a640fc0df5
      - generated-sources.json
