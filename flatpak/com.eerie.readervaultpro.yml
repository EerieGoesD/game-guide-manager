id: com.eerie.readervaultpro
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: "24.08"

sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22

command: reader-vault-pro
separate-locales: false

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network

modules:
  # 1) Build and install libvips into /app (no JXL to avoid SDK mismatch)
  - libvips.json

  # 2) Build your app; sharp builds from source and links against global /app libvips
  - name: reader-vault-pro
    buildsystem: simple

    build-options:
      append-path: /usr/lib/sdk/node22/bin
      env:
        XDG_CACHE_HOME: /run/build/reader-vault-pro/flatpak-node/cache
        npm_config_cache: /run/build/reader-vault-pro/flatpak-node/npm-cache

        # force native addons (sharp) to compile from source (no prebuilt downloads)
        npm_config_build_from_source: "true"

        # node headers location for node-gyp
        npm_config_nodedir: /usr/lib/sdk/node22

        NPM_CONFIG_LOGLEVEL: warn
        npm_config_offline: "true"
        npm_config_audit: "false"
        npm_config_fund: "false"

    build-commands:
      - mkdir -p /run/build/reader-vault-pro/flatpak-node/npm-cache

      # IMPORTANT: no localhost server hack; it cannot persist between build-commands
      - npm install --offline

      - npm run build

      - install -d /app/main
      - cp -r dist /app/main/dist

      - if [ -d electron ]; then cp -r electron /app/main/electron; fi
      - if [ -d src ]; then cp -r src /app/main/src; fi
      - if [ -f main.js ]; then install -Dm644 main.js /app/main/main.js; fi

      - install -Dm644 package.json /app/main/package.json
      - if [ -f package-lock.json ]; then install -Dm644 package-lock.json /app/main/package-lock.json; fi

      - install -Dm755 flatpak/reader-vault-pro.sh /app/bin/reader-vault-pro
      - install -Dm644 assets/icon-512.png /app/share/icons/hicolor/512x512/apps/com.eerie.readervaultpro.png
      - install -Dm644 flatpak/com.eerie.readervaultpro.desktop /app/share/applications/com.eerie.readervaultpro.desktop
      - install -Dm644 flatpak/com.eerie.readervaultpro.metainfo.xml /app/share/metainfo/com.eerie.readervaultpro.metainfo.xml

    sources:
      - type: git
        url: https://github.com/EerieGoesD/game-guide-manager.git
        commit: 30f2d9deda4351c8dd3c097c72afb36c7c897e36

      - generated-sources.json
