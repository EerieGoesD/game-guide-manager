id: com.eerie.readervaultpro
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: "24.08"

sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22

command: reader-vault-pro
separate-locales: false

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network

modules:
  - name: reader-vault-pro
    buildsystem: simple

    build-options:
      append-path: /usr/lib/sdk/node22/bin
      env:
        XDG_CACHE_HOME: /run/build/reader-vault-pro/flatpak-node/cache
        npm_config_cache: /run/build/reader-vault-pro/flatpak-node/npm-cache
        npm_config_sharp_libvips_binary_host: "file:///run/build/reader-vault-pro/flatpak-node/sharp-libvips"
        npm_config_nodedir: /usr/lib/sdk/node22
        NPM_CONFIG_LOGLEVEL: warn
        npm_config_offline: "true"
        npm_config_audit: "false"
        npm_config_fund: "false"

    build-commands:
      - mkdir -p /run/build/reader-vault-pro/flatpak-node/npm-cache
      - mkdir -p /run/build/reader-vault-pro/flatpak-node/sharp-libvips
      - npm install --offline
      - npm run build

      - install -d /app/main
      - cp -r dist /app/main/dist

      - if [ -d electron ]; then cp -r electron /app/main/electron; fi
      - if [ -d src ]; then cp -r src /app/main/src; fi
      - if [ -f main.js ]; then install -Dm644 main.js /app/main/main.js; fi

      - install -Dm644 package.json /app/main/package.json
      - if [ -f package-lock.json ]; then install -Dm644 package-lock.json /app/main/package-lock.json; fi

      - install -Dm755 flatpak/reader-vault-pro.sh /app/bin/reader-vault-pro
      - install -Dm644 assets/icon-512.png /app/share/icons/hicolor/512x512/apps/com.eerie.readervaultpro.png
      - install -Dm644 flatpak/com.eerie.readervaultpro.desktop /app/share/applications/com.eerie.readervaultpro.desktop
      - install -Dm644 flatpak/com.eerie.readervaultpro.metainfo.xml /app/share/metainfo/com.eerie.readervaultpro.metainfo.xml

    sources:
      - type: file
        url: https://github.com/lovell/sharp-libvips/releases/download/v8.14.5/libvips-8.14.5-linux-x64.tar.br
        sha256: 11959c03864960f812d861bf7291020540a49fafd2c746b7a3228d9f2bd2200d
        dest: flatpak-node/sharp-libvips
        dest-filename: libvips-8.14.5-linux-x64.tar.br

      - type: git
        url: https://github.com/EerieGoesD/game-guide-manager.git
        commit: e0c35c942695baefa5884d1fc7970132325cda6a
      - generated-sources.json
